<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta http-equiv="Cache-Control" content="no-cache" />
    <meta name="keywords" content="" />
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="author" content="HSKY">
    <meta name="renderer" content="webkit">
    <meta charset="utf-8">
    <title>中国庭审公开网-第三方评价系统</title>
    <link href="/app/assets/imgs/favorite.ico" rel="shortcut icon" type="image/x-icon">
    <!-- <link rel="stylesheet" type="text/css" href="/app/assets/css/public.scss">
    <link rel="stylesheet" type="text/css" href="/app/assets/css/login.scss"> -->
    <link rel="stylesheet" type="text/css" href="/app/assets/css/main.scss">

    <script type="text/javascript" charset="utf-8" src="/app/assets/libs/mod.js"></script>
    <script type="text/javascript" charset="utf-8" src="/app/assets/libs/sjcl.js"></script>
</head>

<body>
    <div class="c-log-index">
        <div class="log-index-content clearfix">
            <img src="../../assets/imgs/c-login-log.png" class="log-ico">
            <div class="log-form">
                <h2 class="clearfix"><span>帐号登录</span><a href="#" style="display:none;">免费注册</a></h2>
                <form action="">
                    <input type="text" placeholder="用户名/手机号" class="log-num" id="username">
                    <input type="password" placeholder="请输入密码" class="log-pwd" id="password">
                    <label style="display:none;"><!-- <input type="checkbox">下次自动登录 --></label>
                    <div class="verif" id="verif-div" >
                    <input type="text" id="vefifyCode" name="verifyPic" autocomplete="off" placeholder="请输入验证码">
                    <span class="verifcode" id="verif-span"></span>
                    <input type="hidden" id="hdCode"  value="" name="vpToken">
                    <span class="refresh" onclick="getVerifyPic();">看不清楚<br/>换一张</span>
                    </div>
                    <input type="button" class="submit" value="登录" onclick="login();" />
                </form>
            </div>
        </div>
    </div>
    <div class="c-log-footer">
        <p>中华人民共和国最高人民法院 版权所有，未经协议授权禁止下载使用或建立镜像. 京ICP备05023036号</p>
    </div>
</body>
<script>
var $ = require('jquery');
    $.ajaxSetup({
      cache: false
    });
var layer = require('app/assets/libs/layer/layer');
document.onkeydown = function (event) {
    var e = event || window.event || arguments.callee.caller.arguments[0];
    if (e && e.keyCode == 13) { // enter 键
        login();
    }
};



function getVerifyPic() {
        var url = "/getVerifyPic";
        $.ajax({
            //xhrFields: {
            //    withCredentials: true
            //},
            url: url,
            type: 'GET',
            async: false,
            cache: false
            //data: 't=' + Date.now()
        }).done(function (data) {
            if (data && data.code == 0) {
                //注册成功后登录
                $('#verif-span').empty().append('<img src="data:image/jpg;base64,' + data.data.base64 + '">');
                $("#hdCode").val(data.data.vpToken);
            } else {
                console.error('呵呵!代码写错了!')
            }
        })
    }

function login() {
    var username = $("#username").val();
    var password = $("#password").val();
    var hdCode = $("#hdCode").val();
    var vefifyCode = $("#vefifyCode").val();
    if (!username) {
        layer.alert('请输入用户名');
        return;
    }
    if (!password) {
        layer.alert('请输入密码');
        return;
    }
    if (hdCode) {
        if (!vefifyCode) {
          layer.alert('请输入验证码');
          $('#verif-div').show();
          getVerifyPic();
          return;  
        }
    }
    var Crypto = require('app/assets/libs/crypto/crypto'),
        crypto = new Crypto();
    crypto.encrypt(password, function (cryptoModel) {
        cryptoModel.userName = username;
        cryptoModel.vpToken = hdCode;
        cryptoModel.verifyPic = vefifyCode;
        doLogin(cryptoModel);
    })
}

function doLogin(cryptoModel) {
    var url = reqConfig.getInterface('login');
    $.ajax({
        url: url,
        data: cryptoModel,
        type: 'post',
        async: false,
        dataType: 'json',
        success: function (data) {
           if (data.code == 0) {
                location.href = '@_CONTEXT_/index'; 
            } else if (data.code == -1) {
                layer.alert("用户名或密码出错!");
                return;
            } else if (data.code == -3) {
                $('#verif-div').show();
                getVerifyPic();
                layer.alert("请输入正确的验证码！");
            } else if (data.code == -4) {
                $('#verif-div').show();
                getVerifyPic();
                layer.alert("用户名或密码出错!");

            }else if(data.code == -5){
                location.href = "@_CONTEXT_/password";
            }
        },
        error: function () {
            layer.alert('登录失败，网络异常！');
            return;
        }
    });
}

function setCookie(name, value) {
    var Days = 30;
    var exp = new Date();
    exp.setTime(exp.getTime() + Days * 24 * 60 * 60 * 1000);
    document.cookie = name + "=" + escape(value) + ";expires=" + exp.toGMTString();
}
</script>

</html>